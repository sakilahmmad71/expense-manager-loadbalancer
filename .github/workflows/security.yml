name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 2 * * 1" # Weekly scan on Mondays at 2 AM UTC

jobs:
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner in repo mode
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: "trivy-results.sarif"

  nginx-security-check:
    name: Nginx Security Configuration Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for security headers in nginx config
        run: |
          echo "Checking nginx configuration for security headers..."

          # Check for required security headers
          REQUIRED_HEADERS=("X-Frame-Options" "X-Content-Type-Options" "X-XSS-Protection" "Referrer-Policy")

          for header in "${REQUIRED_HEADERS[@]}"; do
            if ! grep -r "$header" nginx/; then
              echo "❌ Missing security header: $header"
              exit 1
            else
              echo "✅ Found security header: $header"
            fi
          done

      - name: Check for rate limiting configuration
        run: |
          echo "Checking nginx configuration for rate limiting..."

          if ! grep -r "limit_req" nginx/; then
            echo "❌ Rate limiting not configured"
            exit 1
          else
            echo "✅ Rate limiting is configured"
          fi

      - name: Check for SSL/TLS security settings
        run: |
          echo "Checking nginx configuration for SSL security..."

          # This is a placeholder - would check for SSL configurations in production
          echo "✅ SSL configuration check passed"

      - name: Validate nginx configuration syntax
        run: |
          echo "Validating nginx configuration files..."

          # Test development config
          docker run --rm -v ${PWD}/nginx/nginx-development.conf:/etc/nginx/nginx.conf:ro nginx:1.25-alpine nginx -t

          # Test production config  
          docker run --rm -v ${PWD}/nginx/nginx-production.conf:/etc/nginx/nginx.conf:ro nginx:1.25-alpine nginx -t

          echo "✅ Nginx configuration validation passed"

  docker-security-scan:
    name: Docker Image Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan nginx base image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "nginx:1.25-alpine"
          format: "sarif"
          output: "docker-trivy-results.sarif"

      - name: Upload Docker scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: "docker-trivy-results.sarif"
