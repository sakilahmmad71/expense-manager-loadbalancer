# Rate Limiting Configuration Examples

# This example shows various rate limiting strategies

# ==============================================================================
# Basic Rate Limiting
# ==============================================================================
http {
    # Define rate limit zones
    limit_req_zone $binary_remote_addr zone=general:10m rate=100r/s;
    limit_req_zone $binary_remote_addr zone=auth:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=api:10m rate=50r/s;
    
    server {
        # Apply rate limiting to all locations
        location / {
            limit_req zone=general burst=200 nodelay;
            # ... proxy config
        }
        
        # Stricter limits for auth endpoints
        location /api/auth/ {
            limit_req zone=auth burst=20 nodelay;
            # ... proxy config
        }
    }
}

# ==============================================================================
# Advanced Rate Limiting by Endpoint
# ==============================================================================
http {
    # Different zones for different purposes
    limit_req_zone $binary_remote_addr zone=read_api:10m rate=100r/s;
    limit_req_zone $binary_remote_addr zone=write_api:10m rate=20r/s;
    limit_req_zone $binary_remote_addr zone=public:10m rate=200r/s;
    
    server {
        # Read operations (GET)
        location ~ ^/api/.*$ {
            if ($request_method = GET) {
                limit_req zone=read_api burst=200 nodelay;
            }
            
            # Write operations (POST, PUT, DELETE)
            if ($request_method ~ (POST|PUT|DELETE|PATCH)) {
                limit_req zone=write_api burst=40 nodelay;
            }
            
            proxy_pass http://api_backend;
        }
        
        # Public endpoints (no rate limit or relaxed)
        location /api/public/ {
            limit_req zone=public burst=500 nodelay;
            proxy_pass http://api_backend;
        }
    }
}

# ==============================================================================
# Connection Limits
# ==============================================================================
http {
    # Limit concurrent connections per IP
    limit_conn_zone $binary_remote_addr zone=addr:10m;
    
    server {
        # Max 20 concurrent connections per IP
        limit_conn addr 20;
        
        # Stricter for specific endpoints
        location /api/upload/ {
            limit_conn addr 5;  # Only 5 concurrent uploads per IP
            proxy_pass http://api_backend;
        }
    }
}

# ==============================================================================
# Rate Limiting with Custom Key (e.g., API Key)
# ==============================================================================
http {
    # Rate limit by API key instead of IP
    map $http_x_api_key $api_client_key {
        default $http_x_api_key;
        "" $binary_remote_addr;  # Fallback to IP if no API key
    }
    
    limit_req_zone $api_client_key zone=by_api_key:10m rate=1000r/s;
    
    server {
        location /api/ {
            limit_req zone=by_api_key burst=2000 nodelay;
            proxy_pass http://api_backend;
        }
    }
}

# ==============================================================================
# Whitelist IPs from Rate Limiting
# ==============================================================================
http {
    geo $limit {
        default 1;
        # Internal networks - no limit
        10.0.0.0/8 0;
        192.168.0.0/16 0;
        # Trusted IPs
        1.2.3.4 0;
    }
    
    map $limit $limit_key {
        0 "";
        1 $binary_remote_addr;
    }
    
    limit_req_zone $limit_key zone=limited:10m rate=50r/s;
    
    server {
        location /api/ {
            limit_req zone=limited burst=100 nodelay;
            proxy_pass http://api_backend;
        }
    }
}

# ==============================================================================
# Custom Error Responses
# ==============================================================================
server {
    location /api/ {
        limit_req zone=api_limit burst=100 nodelay;
        limit_req_status 429;  # Return 429 Too Many Requests
        
        proxy_pass http://api_backend;
    }
    
    # Custom error page for rate limiting
    error_page 429 /rate_limit.json;
    location = /rate_limit.json {
        internal;
        default_type application/json;
        return 429 '{"error": "Rate limit exceeded", "code": 429, "message": "Too many requests. Please try again later."}';
    }
}

# ==============================================================================
# Notes:
# - rate=10r/s means 10 requests per second
# - burst allows temporary traffic spikes
# - nodelay applies rate limit immediately
# - delay queues requests when limit is exceeded
# - Test rate limits: for i in {1..100}; do curl http://localhost/api/health; done
# ==============================================================================